<div class="checkout-container">
  <h1 class="checkout-title">Checkout</h1>

  @if (error) {
    <div class="alert alert-error">{{ error }}</div>
  }

  @if ((cartService.items$ | async)?.length === 0) {
    <div class="empty-cart">
      <p>Your cart is empty</p>
      <a routerLink="/" class="btn btn-primary">Continue Shopping</a>
    </div>
  } @else {
    <div class="checkout-content">
      <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()" class="checkout-form">
        <div class="form-sections">
          <!-- Customer Information -->
          <section class="form-section">
            <h2>Customer Information</h2>
            <div formGroupName="customer">
              <div class="form-group">
                <label for="email">Email *</label>
                <input 
                  type="email" 
                  id="email" 
                  formControlName="email"
                  [class.invalid]="isFieldInvalid('customer.email')"
                  placeholder="john@example.com">
                @if (isFieldInvalid('customer.email')) {
                  <span class="error-message">{{ getFieldError('customer.email') }}</span>
                }
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="firstName">First Name *</label>
                  <input 
                    type="text" 
                    id="firstName" 
                    formControlName="firstName"
                    [class.invalid]="isFieldInvalid('customer.firstName')"
                    placeholder="John">
                  @if (isFieldInvalid('customer.firstName')) {
                    <span class="error-message">{{ getFieldError('customer.firstName') }}</span>
                  }
                </div>

                <div class="form-group">
                  <label for="lastName">Last Name *</label>
                  <input 
                    type="text" 
                    id="lastName" 
                    formControlName="lastName"
                    [class.invalid]="isFieldInvalid('customer.lastName')"
                    placeholder="Doe">
                  @if (isFieldInvalid('customer.lastName')) {
                    <span class="error-message">{{ getFieldError('customer.lastName') }}</span>
                  }
                </div>
              </div>
            </div>

            <!-- Account Creation (for subscriptions) -->
            @if (requiresAccount) {
              <div formGroupName="account" class="account-section">
                <div class="info-box">
                  <p>Your cart contains a subscription. Please create an account to manage your subscription.</p>
                </div>
                
                <div class="form-group">
                  <label for="password">Password *</label>
                  <input 
                    type="password" 
                    id="password" 
                    formControlName="password"
                    [class.invalid]="isFieldInvalid('account.password')"
                    placeholder="Minimum 8 characters">
                  @if (isFieldInvalid('account.password')) {
                    <span class="error-message">{{ getFieldError('account.password') }}</span>
                  }
                </div>

                <div class="form-group">
                  <label for="confirmPassword">Confirm Password *</label>
                  <input 
                    type="password" 
                    id="confirmPassword" 
                    formControlName="confirmPassword"
                    [class.invalid]="isFieldInvalid('account.confirmPassword')"
                    placeholder="Confirm your password">
                  @if (isFieldInvalid('account.confirmPassword')) {
                    <span class="error-message">{{ getFieldError('account.confirmPassword') }}</span>
                  }
                </div>
              </div>
            }
          </section>

          <!-- Billing Address -->
          <section class="form-section">
            <h2>Billing Address</h2>
            <div formGroupName="billingAddress">
              <div class="form-row">
                <div class="form-group">
                  <label for="billingFirstName">First Name *</label>
                  <input 
                    type="text" 
                    id="billingFirstName" 
                    formControlName="firstName"
                    [class.invalid]="isFieldInvalid('billingAddress.firstName')">
                  @if (isFieldInvalid('billingAddress.firstName')) {
                    <span class="error-message">{{ getFieldError('billingAddress.firstName') }}</span>
                  }
                </div>

                <div class="form-group">
                  <label for="billingLastName">Last Name *</label>
                  <input 
                    type="text" 
                    id="billingLastName" 
                    formControlName="lastName"
                    [class.invalid]="isFieldInvalid('billingAddress.lastName')">
                  @if (isFieldInvalid('billingAddress.lastName')) {
                    <span class="error-message">{{ getFieldError('billingAddress.lastName') }}</span>
                  }
                </div>
              </div>

              <div class="form-group">
                <label for="billingLine1">Address *</label>
                <input 
                  type="text" 
                  id="billingLine1" 
                  formControlName="line1"
                  [class.invalid]="isFieldInvalid('billingAddress.line1')"
                  placeholder="123 Main St">
                @if (isFieldInvalid('billingAddress.line1')) {
                  <span class="error-message">{{ getFieldError('billingAddress.line1') }}</span>
                }
              </div>

              <div class="form-group">
                <label for="billingLine2">Apartment, suite, etc. (optional)</label>
                <input 
                  type="text" 
                  id="billingLine2" 
                  formControlName="line2"
                  placeholder="Apt 4B">
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="billingCity">City *</label>
                  <input 
                    type="text" 
                    id="billingCity" 
                    formControlName="city"
                    [class.invalid]="isFieldInvalid('billingAddress.city')">
                  @if (isFieldInvalid('billingAddress.city')) {
                    <span class="error-message">{{ getFieldError('billingAddress.city') }}</span>
                  }
                </div>

                <div class="form-group">
                  <label for="billingRegion">State/Province</label>
                  <input 
                    type="text" 
                    id="billingRegion" 
                    formControlName="region">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="billingPostcode">Postal Code *</label>
                  <input 
                    type="text" 
                    id="billingPostcode" 
                    formControlName="postcode"
                    [class.invalid]="isFieldInvalid('billingAddress.postcode')">
                  @if (isFieldInvalid('billingAddress.postcode')) {
                    <span class="error-message">{{ getFieldError('billingAddress.postcode') }}</span>
                  }
                </div>

                <div class="form-group">
                  <label for="billingCountry">Country *</label>
                  <input 
                    type="text" 
                    id="billingCountry" 
                    formControlName="country"
                    [class.invalid]="isFieldInvalid('billingAddress.country')"
                    placeholder="US">
                  @if (isFieldInvalid('billingAddress.country')) {
                    <span class="error-message">{{ getFieldError('billingAddress.country') }}</span>
                  }
                </div>
              </div>
            </div>
          </section>

          <!-- Shipping Address -->
          <section class="form-section">
            <div class="section-header">
              <h2>Shipping Address</h2>
              <label class="checkbox-label">
                <input 
                  type="checkbox" 
                  formControlName="sameAsShipping">
                Same as billing address
              </label>
            </div>

            @if (!checkoutForm.get('sameAsShipping')?.value) {
              <div formGroupName="shippingAddress">
                <div class="form-row">
                  <div class="form-group">
                    <label for="shippingFirstName">First Name *</label>
                    <input 
                      type="text" 
                      id="shippingFirstName" 
                      formControlName="firstName"
                      [class.invalid]="isFieldInvalid('shippingAddress.firstName')">
                    @if (isFieldInvalid('shippingAddress.firstName')) {
                      <span class="error-message">{{ getFieldError('shippingAddress.firstName') }}</span>
                    }
                  </div>

                  <div class="form-group">
                    <label for="shippingLastName">Last Name *</label>
                    <input 
                      type="text" 
                      id="shippingLastName" 
                      formControlName="lastName"
                      [class.invalid]="isFieldInvalid('shippingAddress.lastName')">
                    @if (isFieldInvalid('shippingAddress.lastName')) {
                      <span class="error-message">{{ getFieldError('shippingAddress.lastName') }}</span>
                    }
                  </div>
                </div>

                <div class="form-group">
                  <label for="shippingLine1">Address *</label>
                  <input 
                    type="text" 
                    id="shippingLine1" 
                    formControlName="line1"
                    [class.invalid]="isFieldInvalid('shippingAddress.line1')"
                    placeholder="123 Main St">
                  @if (isFieldInvalid('shippingAddress.line1')) {
                    <span class="error-message">{{ getFieldError('shippingAddress.line1') }}</span>
                  }
                </div>

                <div class="form-group">
                  <label for="shippingLine2">Apartment, suite, etc. (optional)</label>
                  <input 
                    type="text" 
                    id="shippingLine2" 
                    formControlName="line2"
                    placeholder="Apt 4B">
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="shippingCity">City *</label>
                    <input 
                      type="text" 
                      id="shippingCity" 
                      formControlName="city"
                      [class.invalid]="isFieldInvalid('shippingAddress.city')">
                    @if (isFieldInvalid('shippingAddress.city')) {
                      <span class="error-message">{{ getFieldError('shippingAddress.city') }}</span>
                    }
                  </div>

                  <div class="form-group">
                    <label for="shippingRegion">State/Province</label>
                    <input 
                      type="text" 
                      id="shippingRegion" 
                      formControlName="region">
                  </div>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label for="shippingPostcode">Postal Code *</label>
                    <input 
                      type="text" 
                      id="shippingPostcode" 
                      formControlName="postcode"
                      [class.invalid]="isFieldInvalid('shippingAddress.postcode')">
                    @if (isFieldInvalid('shippingAddress.postcode')) {
                      <span class="error-message">{{ getFieldError('shippingAddress.postcode') }}</span>
                    }
                  </div>

                  <div class="form-group">
                    <label for="shippingCountry">Country *</label>
                    <input 
                      type="text" 
                      id="shippingCountry" 
                      formControlName="country"
                      [class.invalid]="isFieldInvalid('shippingAddress.country')"
                      placeholder="US">
                    @if (isFieldInvalid('shippingAddress.country')) {
                      <span class="error-message">{{ getFieldError('shippingAddress.country') }}</span>
                    }
                  </div>
                </div>
              </div>
            }
          </section>


          <!-- Payment -->
          <section class="form-section">
            <h2>Payment</h2>
            @if (!stripeInitialized) {
              <div class="payment-loading">Loading payment system...</div>
            } @else {
              <div class="payment-info">
                <p>Payment details will be collected securely when you click "Complete Order".</p>
                <p class="payment-note">Your card won't be charged until you confirm the order.</p>
              </div>
            }
          </section>
        </div>

        <!-- Order Summary -->
        <div class="order-summary">
          <h2>Order Summary</h2>
          
          <div class="summary-items">
            @for (item of (cartService.items$ | async); track getItemId(item)) {
              <div class="summary-item">
                <span class="item-name">
                  {{ getItemName(item) }}
                  @let quantity = getItemQuantity(item);
                  @if (quantity && quantity > 1) {
                    <span class="item-quantity">x{{ quantity }}</span>
                  }
                </span>
                <span class="item-price">
                  {{ getItemTotal(item) }}
                </span>
              </div>
            }
          </div>

          <div class="summary-totals">
            @let totals = cartService.totals$ | async;
            @if (totals) {
              <div class="summary-line">
                <span>Subtotal</span>
                <span>{{ totals.subtotal }}</span>
              </div>
              
              @if (totals.hasDiscount) {
                <div class="summary-line discount">
                  <span>Discount</span>
                  <span>{{ totals.discount }}</span>
                </div>
              }

              
              <div class="summary-line">
                <span>Tax</span>
                <span>{{ totals.tax }}</span>
              </div>
              
              <div class="summary-line total">
                <span>Total</span>
                <span>{{ totals.total }}</span>
              </div>
            }
          </div>

          <button 
            type="submit" 
            class="btn btn-primary btn-block"
            [disabled]="loading || checkoutForm.invalid">
            @if (loading) {
              Processing...
            } @else {
              Complete Order
            }
          </button>
        </div>
      </form>
    </div>
  }
</div>