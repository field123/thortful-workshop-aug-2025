<div class="checkout-container">
  <h1 class="checkout-title">Checkout</h1>

  @if (error) {
    <div class="alert alert-error">{{ error }}</div>
  }

  @if ((cartService.items$ | async)?.length === 0) {
    <div class="empty-cart">
      <p>Your cart is empty</p>
      <a routerLink="/" class="btn btn-primary">Continue Shopping</a>
    </div>
  } @else {
    <div class="checkout-content">
      <form [formGroup]="checkoutForm" (ngSubmit)="onSubmit()" class="checkout-form">
        <div class="form-sections">
          <!-- Customer Information -->
          <section class="form-section">
            <h2>Customer Information</h2>
            <div formGroupName="customer">
              <div class="form-group">
                <label for="email">Email *</label>
                <input 
                  type="email" 
                  id="email" 
                  formControlName="email"
                  [class.invalid]="isFieldInvalid('customer.email')"
                  placeholder="john@example.com">
                @if (isFieldInvalid('customer.email')) {
                  <span class="error-message">{{ getFieldError('customer.email') }}</span>
                }
              </div>

              <div class="form-group">
                <label for="name">Full Name *</label>
                <input 
                  type="text" 
                  id="name" 
                  formControlName="name"
                  [class.invalid]="isFieldInvalid('customer.name')"
                  placeholder="John Doe">
                @if (isFieldInvalid('customer.name')) {
                  <span class="error-message">{{ getFieldError('customer.name') }}</span>
                }
              </div>
            </div>
          </section>

          <!-- Billing Address -->
          <section class="form-section">
            <h2>Billing Address</h2>
            <div formGroupName="billingAddress">
              <div class="form-row">
                <div class="form-group">
                  <label for="billingFirstName">First Name *</label>
                  <input 
                    type="text" 
                    id="billingFirstName" 
                    formControlName="first_name"
                    [class.invalid]="isFieldInvalid('billingAddress.first_name')">
                  @if (isFieldInvalid('billingAddress.first_name')) {
                    <span class="error-message">{{ getFieldError('billingAddress.first_name') }}</span>
                  }
                </div>

                <div class="form-group">
                  <label for="billingLastName">Last Name *</label>
                  <input 
                    type="text" 
                    id="billingLastName" 
                    formControlName="last_name"
                    [class.invalid]="isFieldInvalid('billingAddress.last_name')">
                  @if (isFieldInvalid('billingAddress.last_name')) {
                    <span class="error-message">{{ getFieldError('billingAddress.last_name') }}</span>
                  }
                </div>
              </div>

              <div class="form-group">
                <label for="billingLine1">Address *</label>
                <input 
                  type="text" 
                  id="billingLine1" 
                  formControlName="line_1"
                  [class.invalid]="isFieldInvalid('billingAddress.line_1')"
                  placeholder="123 Main St">
                @if (isFieldInvalid('billingAddress.line_1')) {
                  <span class="error-message">{{ getFieldError('billingAddress.line_1') }}</span>
                }
              </div>

              <div class="form-group">
                <label for="billingLine2">Apartment, suite, etc. (optional)</label>
                <input 
                  type="text" 
                  id="billingLine2" 
                  formControlName="line_2"
                  placeholder="Apt 4B">
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="billingCity">City *</label>
                  <input 
                    type="text" 
                    id="billingCity" 
                    formControlName="city"
                    [class.invalid]="isFieldInvalid('billingAddress.city')">
                  @if (isFieldInvalid('billingAddress.city')) {
                    <span class="error-message">{{ getFieldError('billingAddress.city') }}</span>
                  }
                </div>

                <div class="form-group">
                  <label for="billingRegion">State/Province</label>
                  <input 
                    type="text" 
                    id="billingRegion" 
                    formControlName="region">
                </div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="billingPostcode">Postal Code *</label>
                  <input 
                    type="text" 
                    id="billingPostcode" 
                    formControlName="postcode"
                    [class.invalid]="isFieldInvalid('billingAddress.postcode')">
                  @if (isFieldInvalid('billingAddress.postcode')) {
                    <span class="error-message">{{ getFieldError('billingAddress.postcode') }}</span>
                  }
                </div>

                <div class="form-group">
                  <label for="billingCountry">Country *</label>
                  <input 
                    type="text" 
                    id="billingCountry" 
                    formControlName="country"
                    [class.invalid]="isFieldInvalid('billingAddress.country')"
                    placeholder="US">
                  @if (isFieldInvalid('billingAddress.country')) {
                    <span class="error-message">{{ getFieldError('billingAddress.country') }}</span>
                  }
                </div>
              </div>
            </div>
          </section>
        </div>

        <!-- Order Summary -->
        <div class="order-summary">
          <h2>Order Summary</h2>
          
          <div class="summary-items">
            @for (item of (cartService.items$ | async); track getItemId(item)) {
              <div class="summary-item">
                <span class="item-name">
                  {{ getItemName(item) }}
                  @let quantity = getItemQuantity(item);
                  @if (quantity && quantity > 1) {
                    <span class="item-quantity">x{{ quantity }}</span>
                  }
                </span>
                <span class="item-price">
                  {{ getItemTotal(item) }}
                </span>
              </div>
            }
          </div>

          <div class="summary-totals">
            @let totals = cartService.totals$ | async;
            @if (totals) {
              <div class="summary-line">
                <span>Subtotal</span>
                <span>{{ totals.subtotal }}</span>
              </div>
              
              @if (totals.hasDiscount) {
                <div class="summary-line discount">
                  <span>Discount</span>
                  <span>{{ totals.discount }}</span>
                </div>
              }
              
              <div class="summary-line">
                <span>Tax</span>
                <span>{{ totals.tax }}</span>
              </div>
              
              <div class="summary-line total">
                <span>Total</span>
                <span>{{ totals.total }}</span>
              </div>
            }
          </div>

          <button 
            type="submit" 
            class="btn btn-primary btn-block"
            [disabled]="loading || checkoutForm.invalid">
            @if (loading) {
              Creating Order...
            } @else {
              Continue to Payment
            }
          </button>
        </div>
      </form>
    </div>
  }
</div>